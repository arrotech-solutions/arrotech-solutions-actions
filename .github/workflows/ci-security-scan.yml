# =============================================================================
# Reusable Security Scanning Workflow
# =============================================================================
# This workflow provides comprehensive security scanning including:
# - CodeQL for SAST (Static Application Security Testing)
# - Dependency vulnerability scanning
# - Secret detection
# - Container scanning (if Dockerfile present)
#
# Usage in consuming repo:
#   jobs:
#     security:
#       uses: arrotech-solutions/arrotech-solutions-actions/.github/workflows/ci-security-scan.yml@main
#       with:
#         language: 'javascript'
#         enable-codeql: true
#         enable-dependency-scan: true
# =============================================================================

name: Security Scanning

on:
  workflow_call:
    inputs:
      language:
        description: 'Primary language for CodeQL: javascript, python, go, java, csharp, cpp, ruby'
        required: true
        type: string
        default: 'javascript'
      enable-codeql:
        description: 'Enable CodeQL SAST scanning'
        required: false
        type: boolean
        default: true
      enable-dependency-scan:
        description: 'Enable dependency vulnerability scanning'
        required: false
        type: boolean
        default: true
      enable-secret-scan:
        description: 'Enable secret detection scanning'
        required: false
        type: boolean
        default: true
      enable-container-scan:
        description: 'Enable container image scanning'
        required: false
        type: boolean
        default: false
      container-image:
        description: 'Container image to scan (for container scanning)'
        required: false
        type: string
        default: ''
      fail-on-high-severity:
        description: 'Fail build on high/critical severity findings'
        required: false
        type: boolean
        default: true
      working-directory:
        description: 'Working directory for scans'
        required: false
        type: string
        default: '.'
    outputs:
      security-result:
        description: 'Overall security scan result'
        value: ${{ jobs.summary.outputs.result }}
    secrets:
      SNYK_TOKEN:
        description: 'Snyk API token for vulnerability scanning'
        required: false

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  # ---------------------------------------------------------------------------
  # CodeQL SAST Scanning
  # ---------------------------------------------------------------------------
  codeql:
    name: CodeQL Analysis
    if: inputs.enable-codeql
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ inputs.language }}"

  # ---------------------------------------------------------------------------
  # Dependency Vulnerability Scanning
  # ---------------------------------------------------------------------------
  dependency-scan:
    name: Dependency Vulnerability Scan
    if: inputs.enable-dependency-scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Node.js dependency audit
      - name: Detect Node.js project
        id: detect-node
        run: |
          if [ -f "package.json" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.detect-node.outputs.found == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        if: steps.detect-node.outputs.found == 'true'
        run: |
          npm ci --ignore-scripts
          npm audit --audit-level=high
        continue-on-error: ${{ !inputs.fail-on-high-severity }}

      # Python dependency audit
      - name: Detect Python project
        id: detect-python
        run: |
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "Pipfile" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        if: steps.detect-python.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run pip-audit
        if: steps.detect-python.outputs.found == 'true'
        run: |
          pip install pip-audit
          pip-audit --ignore-vuln GHSA-xxxx-xxxx-xxxx || true
          pip-audit --strict
        continue-on-error: ${{ !inputs.fail-on-high-severity }}

      # Go dependency audit
      - name: Detect Go project
        id: detect-go
        run: |
          if [ -f "go.mod" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Go
        if: steps.detect-go.outputs.found == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run govulncheck
        if: steps.detect-go.outputs.found == 'true'
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
        continue-on-error: ${{ !inputs.fail-on-high-severity }}

      # Snyk scanning (if token provided)
      - name: Run Snyk vulnerability scan
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # ---------------------------------------------------------------------------
  # Secret Detection
  # ---------------------------------------------------------------------------
  secret-scan:
    name: Secret Detection
    if: inputs.enable-secret-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # ---------------------------------------------------------------------------
  # Container Image Scanning
  # ---------------------------------------------------------------------------
  container-scan:
    name: Container Security Scan
    if: inputs.enable-container-scan && inputs.container-image != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ inputs.container-image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: ${{ inputs.fail-on-high-severity && '1' || '0' }}

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql, dependency-scan, secret-scan, container-scan]
    if: always()
    outputs:
      result: ${{ steps.evaluate.outputs.result }}
    steps:
      - name: Evaluate security scan results
        id: evaluate
        run: |
          CODEQL="${{ needs.codeql.result }}"
          DEPS="${{ needs.dependency-scan.result }}"
          SECRETS="${{ needs.secret-scan.result }}"
          CONTAINER="${{ needs.container-scan.result }}"
          
          echo "::group::Security Scan Results"
          echo "CodeQL: $CODEQL"
          echo "Dependency Scan: $DEPS"
          echo "Secret Scan: $SECRETS"
          echo "Container Scan: $CONTAINER"
          echo "::endgroup::"
          
          # Fail if any critical scan failed
          if [[ "$SECRETS" == "failure" ]]; then
            echo "::error::Secret detection found exposed secrets!"
            echo "result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [[ "${{ inputs.fail-on-high-severity }}" == "true" ]]; then
            if [[ "$CODEQL" == "failure" ]] || \
               [[ "$DEPS" == "failure" ]] || \
               [[ "$CONTAINER" == "failure" ]]; then
              echo "result=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
          
          echo "result=passed" >> $GITHUB_OUTPUT


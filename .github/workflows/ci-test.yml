# =============================================================================
# Reusable Testing Workflow
# =============================================================================
# This workflow runs automated tests with coverage reporting.
# Supports: Node.js, Python, Go with configurable test commands.
#
# Usage in consuming repo:
#   jobs:
#     test:
#       uses: arrotech-solutions/arrotech-solutions-actions/.github/workflows/ci-test.yml@main
#       with:
#         language: 'node'
#         test-command: 'npm test'
#         coverage-threshold: 80
# =============================================================================

name: Automated Testing

on:
  workflow_call:
    inputs:
      language:
        description: 'Primary language: node, python, go'
        required: false
        type: string
        default: 'node'
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
      python-version:
        description: 'Python version'
        required: false
        type: string
        default: '3.11'
      go-version:
        description: 'Go version'
        required: false
        type: string
        default: '1.21'
      test-command:
        description: 'Custom test command (overrides default)'
        required: false
        type: string
        default: ''
      coverage-command:
        description: 'Custom coverage command'
        required: false
        type: string
        default: ''
      coverage-threshold:
        description: 'Minimum coverage percentage to pass'
        required: false
        type: number
        default: 0
      working-directory:
        description: 'Working directory'
        required: false
        type: string
        default: '.'
      upload-coverage:
        description: 'Upload coverage report as artifact'
        required: false
        type: boolean
        default: true
      run-integration-tests:
        description: 'Run integration tests'
        required: false
        type: boolean
        default: false
      integration-test-command:
        description: 'Integration test command'
        required: false
        type: string
        default: ''
      parallel-tests:
        description: 'Run tests in parallel (if supported)'
        required: false
        type: boolean
        default: true
    outputs:
      test-result:
        description: 'Test result: passed or failed'
        value: ${{ jobs.test.outputs.result }}
      coverage-percentage:
        description: 'Code coverage percentage'
        value: ${{ jobs.test.outputs.coverage }}
    secrets:
      TEST_ENV_VARS:
        description: 'Additional environment variables for tests (JSON format)'
        required: false

jobs:
  # ---------------------------------------------------------------------------
  # Node.js Tests
  # ---------------------------------------------------------------------------
  test-node:
    name: Test Node.js
    if: inputs.language == 'node'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.test.outcome }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        id: test
        env:
          CI: true
          NODE_ENV: test
          TEST_COMMAND: ${{ inputs.test-command }}
        run: |
          if [ -n "$TEST_COMMAND" ]; then
            eval "$TEST_COMMAND"
          else
            # Detect test framework and use appropriate flags
            if grep -q '"vitest"' package.json 2>/dev/null; then
              echo "Detected Vitest - running with Vitest flags"
              npm test -- --run
            elif grep -q '"jest"' package.json 2>/dev/null; then
              echo "Detected Jest - running with Jest flags"
              npm test -- --coverage --watchAll=false
            else
              # Generic fallback - just run npm test
              echo "Running npm test"
              npm test
            fi
          fi

      - name: Run coverage
        id: coverage
        if: inputs.coverage-threshold > 0
        env:
          COVERAGE_COMMAND: ${{ inputs.coverage-command }}
          COVERAGE_THRESHOLD: ${{ inputs.coverage-threshold }}
        run: |
          if [ -n "$COVERAGE_COMMAND" ]; then
            eval "$COVERAGE_COMMAND"
          elif [ -f "coverage/coverage-summary.json" ]; then
            # Parse coverage from Jest/Vitest JSON output
            COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
            
            if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
              echo "::error::Coverage $COVERAGE% is below threshold $COVERAGE_THRESHOLD%"
              exit 1
            fi
          elif [ -f "coverage/lcov.info" ]; then
            # Parse coverage from lcov format (Vitest default)
            COVERAGE=$(awk -F: '/LF:/{lf+=$2} /LH:/{lh+=$2} END{if(lf>0) printf "%.2f", (lh/lf)*100; else print "0"}' coverage/lcov.info)
            echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
            
            if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
              echo "::error::Coverage $COVERAGE% is below threshold $COVERAGE_THRESHOLD%"
              exit 1
            fi
          else
            echo "No coverage data found - ensure coverage is configured in your test setup"
          fi
        continue-on-error: false

      - name: Upload coverage report
        if: inputs.upload-coverage && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-node
          path: ${{ inputs.working-directory }}/coverage/
          retention-days: 7

      - name: Run integration tests
        if: inputs.run-integration-tests
        env:
          CI: true
          NODE_ENV: test
          INTEGRATION_TEST_COMMAND: ${{ inputs.integration-test-command }}
        run: |
          if [ -n "$INTEGRATION_TEST_COMMAND" ]; then
            eval "$INTEGRATION_TEST_COMMAND"
          else
            npm run test:integration || echo "No integration test script found"
          fi

  # ---------------------------------------------------------------------------
  # Python Tests
  # ---------------------------------------------------------------------------
  test-python:
    name: Test Python
    if: inputs.language == 'python'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.test.outcome }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f pyproject.toml ]; then pip install -e ".[dev]" || pip install -e .; fi

      - name: Run unit tests
        id: test
        env:
          PYTHONPATH: ${{ inputs.working-directory }}
          TEST_COMMAND: ${{ inputs.test-command }}
          PARALLEL_TESTS: ${{ inputs.parallel-tests }}
        run: |
          if [ -n "$TEST_COMMAND" ]; then
            eval "$TEST_COMMAND"
          elif [ "$PARALLEL_TESTS" = "true" ]; then
            pytest -n auto --cov=. --cov-report=xml --cov-report=term-missing -v
          else
            pytest --cov=. --cov-report=xml --cov-report=term-missing -v
          fi

      - name: Check coverage threshold
        id: coverage
        if: inputs.coverage-threshold > 0
        env:
          COVERAGE_THRESHOLD: ${{ inputs.coverage-threshold }}
        run: |
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(float(tree.getroot().get('line-rate')) * 100)")
          echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
          
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below threshold $COVERAGE_THRESHOLD%"
            exit 1
          fi

      - name: Upload coverage report
        if: inputs.upload-coverage && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-python
          path: |
            ${{ inputs.working-directory }}/coverage.xml
            ${{ inputs.working-directory }}/htmlcov/
          retention-days: 7

      - name: Run integration tests
        if: inputs.run-integration-tests
        env:
          INTEGRATION_TEST_COMMAND: ${{ inputs.integration-test-command }}
        run: |
          if [ -n "$INTEGRATION_TEST_COMMAND" ]; then
            eval "$INTEGRATION_TEST_COMMAND"
          else
            pytest tests/integration/ -v || echo "No integration tests found"
          fi

  # ---------------------------------------------------------------------------
  # Go Tests
  # ---------------------------------------------------------------------------
  test-go:
    name: Test Go
    if: inputs.language == 'go'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.test.outcome }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        id: test
        env:
          TEST_COMMAND: ${{ inputs.test-command }}
        run: |
          if [ -n "$TEST_COMMAND" ]; then
            eval "$TEST_COMMAND"
          else
            go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
          fi

      - name: Check coverage threshold
        id: coverage
        if: inputs.coverage-threshold > 0
        env:
          COVERAGE_THRESHOLD: ${{ inputs.coverage-threshold }}
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "percentage=$COVERAGE" >> "$GITHUB_OUTPUT"
          
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below threshold $COVERAGE_THRESHOLD%"
            exit 1
          fi

      - name: Upload coverage report
        if: inputs.upload-coverage && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-go
          path: ${{ inputs.working-directory }}/coverage.out
          retention-days: 7

      - name: Run integration tests
        if: inputs.run-integration-tests
        env:
          INTEGRATION_TEST_COMMAND: ${{ inputs.integration-test-command }}
        run: |
          if [ -n "$INTEGRATION_TEST_COMMAND" ]; then
            eval "$INTEGRATION_TEST_COMMAND"
          else
            go test -v -tags=integration ./...
          fi

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  test:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-node, test-python, test-go]
    if: always()
    outputs:
      result: ${{ steps.summary.outputs.result }}
      coverage: ${{ steps.summary.outputs.coverage }}
    steps:
      - name: Aggregate results
        id: summary
        env:
          NODE: ${{ needs.test-node.result }}
          PYTHON: ${{ needs.test-python.result }}
          GO: ${{ needs.test-go.result }}
          NODE_COV: ${{ needs.test-node.outputs.coverage }}
          PYTHON_COV: ${{ needs.test-python.outputs.coverage }}
          GO_COV: ${{ needs.test-go.outputs.coverage }}
        run: |
          echo "::group::Test Results"
          echo "Node.js: $NODE (coverage: $NODE_COV%)"
          echo "Python: $PYTHON (coverage: $PYTHON_COV%)"
          echo "Go: $GO (coverage: $GO_COV%)"
          echo "::endgroup::"
          
          # Set coverage output
          if [ -n "$NODE_COV" ]; then echo "coverage=$NODE_COV" >> "$GITHUB_OUTPUT"; fi
          if [ -n "$PYTHON_COV" ]; then echo "coverage=$PYTHON_COV" >> "$GITHUB_OUTPUT"; fi
          if [ -n "$GO_COV" ]; then echo "coverage=$GO_COV" >> "$GITHUB_OUTPUT"; fi
          
          # Check for failures
          if [[ "$NODE" == "failure" ]] || \
             [[ "$PYTHON" == "failure" ]] || \
             [[ "$GO" == "failure" ]]; then
            echo "result=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          echo "result=passed" >> "$GITHUB_OUTPUT"


# =============================================================================
# Reusable Build & Artifact Workflow
# =============================================================================
# This workflow builds application artifacts and optionally publishes them.
# Supports: Docker images, npm packages, Python packages, Go binaries.
#
# Usage in consuming repo:
#   jobs:
#     build:
#       uses: arrotech-solutions/arrotech-solutions-actions/.github/workflows/cd-build-artifact.yml@main
#       with:
#         artifact-type: 'docker'
#         image-name: 'my-app'
#       secrets:
#         REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# =============================================================================

name: Build & Publish Artifacts

on:
  workflow_call:
    inputs:
      artifact-type:
        description: 'Artifact type: docker, npm, python, go-binary'
        required: true
        type: string
        default: 'docker'
      # Docker-specific inputs
      image-name:
        description: 'Docker image name (without registry)'
        required: false
        type: string
        default: ''
      dockerfile-path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      docker-context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      docker-platforms:
        description: 'Target platforms for multi-arch builds'
        required: false
        type: string
        default: 'linux/amd64'
      registry:
        description: 'Container registry: ghcr, dockerhub, ecr, gcr'
        required: false
        type: string
        default: 'ghcr'
      push-image:
        description: 'Push image to registry'
        required: false
        type: boolean
        default: true
      # npm-specific inputs
      npm-publish:
        description: 'Publish to npm registry'
        required: false
        type: boolean
        default: false
      npm-tag:
        description: 'npm publish tag (latest, next, beta)'
        required: false
        type: string
        default: 'latest'
      # Python-specific inputs
      python-publish:
        description: 'Publish to PyPI'
        required: false
        type: boolean
        default: false
      # Go-specific inputs
      go-binary-name:
        description: 'Name for Go binary'
        required: false
        type: string
        default: 'app'
      go-os:
        description: 'Target OS for Go build (comma-separated)'
        required: false
        type: string
        default: 'linux,darwin,windows'
      go-arch:
        description: 'Target architecture for Go build'
        required: false
        type: string
        default: 'amd64'
      # Common inputs
      working-directory:
        description: 'Working directory'
        required: false
        type: string
        default: '.'
      version-tag:
        description: 'Version tag for artifact'
        required: false
        type: string
        default: ''
      build-args:
        description: 'Build arguments (key=value, newline-separated)'
        required: false
        type: string
        default: ''
    outputs:
      artifact-url:
        description: 'URL or identifier of the published artifact'
        value: ${{ jobs.build.outputs.artifact-url }}
      version:
        description: 'Version of the built artifact'
        value: ${{ jobs.build.outputs.version }}
      digest:
        description: 'Digest of the built artifact (for Docker)'
        value: ${{ jobs.docker.outputs.digest }}
    secrets:
      REGISTRY_TOKEN:
        description: 'Token for container/package registry'
        required: false
      REGISTRY_USERNAME:
        description: 'Username for container/package registry'
        required: false
      NPM_TOKEN:
        description: 'npm registry token'
        required: false
      PYPI_TOKEN:
        description: 'PyPI API token'
        required: false

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKERHUB: docker.io

jobs:
  # ---------------------------------------------------------------------------
  # Docker Build & Push
  # ---------------------------------------------------------------------------
  docker:
    name: Build Docker Image
    if: inputs.artifact-type == 'docker'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      artifact-url: ${{ steps.push.outputs.image-url }}
      version: ${{ steps.meta.outputs.version }}
      digest: ${{ steps.push.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-platform builds)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ inputs.registry == 'ghcr' && format('{0}/{1}/{2}', env.REGISTRY_GHCR, github.repository_owner, inputs.image-name || github.event.repository.name) || '' }}
            ${{ inputs.registry == 'dockerhub' && format('{0}/{1}', secrets.REGISTRY_USERNAME, inputs.image-name || github.event.repository.name) || '' }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            ${{ inputs.version-tag != '' && format('type=raw,value={0}', inputs.version-tag) || '' }}

      - name: Login to GitHub Container Registry
        if: inputs.registry == 'ghcr' && inputs.push-image
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.REGISTRY_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: inputs.registry == 'dockerhub' && inputs.push-image
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_TOKEN }}

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.docker-context }}
          file: ${{ inputs.dockerfile-path }}
          platforms: ${{ inputs.docker-platforms }}
          push: ${{ inputs.push-image }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: ${{ inputs.build-args }}
          provenance: true
          sbom: true

      - name: Output image URL
        run: |
          echo "Image pushed with digest: ${{ steps.push.outputs.digest }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"

  # ---------------------------------------------------------------------------
  # npm Build & Publish
  # ---------------------------------------------------------------------------
  npm:
    name: Build npm Package
    if: inputs.artifact-type == 'npm'
    runs-on: ubuntu-latest
    outputs:
      artifact-url: ${{ steps.publish.outputs.url }}
      version: ${{ steps.version.outputs.version }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Build package
        run: npm run build --if-present

      - name: Pack package
        run: npm pack

      - name: Upload package artifact
        uses: actions/upload-artifact@v6
        with:
          name: npm-package
          path: ${{ inputs.working-directory }}/*.tgz
          retention-days: 30

      - name: Publish to npm
        id: publish
        if: inputs.npm-publish
        run: |
          npm publish --tag ${{ inputs.npm-tag }} --access public
          echo "url=https://www.npmjs.com/package/$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ---------------------------------------------------------------------------
  # Python Build & Publish
  # ---------------------------------------------------------------------------
  python:
    name: Build Python Package
    if: inputs.artifact-type == 'python'
    runs-on: ubuntu-latest
    outputs:
      artifact-url: ${{ steps.publish.outputs.url }}
      version: ${{ steps.version.outputs.version }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Get version
        id: version
        run: |
          if [ -f "pyproject.toml" ]; then
            VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          else
            VERSION=$(python setup.py --version)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload package artifact
        uses: actions/upload-artifact@v6
        with:
          name: python-package
          path: ${{ inputs.working-directory }}/dist/
          retention-days: 30

      - name: Publish to PyPI
        id: publish
        if: inputs.python-publish
        run: |
          twine upload dist/*
          PACKAGE_NAME=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])" 2>/dev/null || python setup.py --name)
          echo "url=https://pypi.org/project/$PACKAGE_NAME" >> $GITHUB_OUTPUT
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # ---------------------------------------------------------------------------
  # Go Binary Build
  # ---------------------------------------------------------------------------
  go-binary:
    name: Build Go Binaries
    if: inputs.artifact-type == 'go-binary'
    runs-on: ubuntu-latest
    outputs:
      artifact-url: ${{ steps.upload.outputs.artifact-url }}
      version: ${{ steps.version.outputs.version }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    strategy:
      matrix:
        goos: ${{ fromJson(format('["{0}"]', join(fromJson(format('["{0}"]', inputs.go-os)), '","'))) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version-tag }}" ]; then
            echo "version=${{ inputs.version-tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(git describe --tags --always --dirty)" >> $GITHUB_OUTPUT
          fi

      - name: Build binaries
        run: |
          IFS=',' read -ra GOOS_LIST <<< "${{ inputs.go-os }}"
          IFS=',' read -ra GOARCH_LIST <<< "${{ inputs.go-arch }}"
          
          for os in "${GOOS_LIST[@]}"; do
            for arch in "${GOARCH_LIST[@]}"; do
              output="${{ inputs.go-binary-name }}-${os}-${arch}"
              if [ "$os" = "windows" ]; then
                output="${output}.exe"
              fi
              
              echo "Building $output..."
              GOOS=$os GOARCH=$arch go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.version }}" -o "dist/$output" .
            done
          done

      - name: Upload binaries
        id: upload
        uses: actions/upload-artifact@v6
        with:
          name: go-binaries
          path: ${{ inputs.working-directory }}/dist/
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  build:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [docker, npm, python, go-binary]
    if: always()
    outputs:
      artifact-url: ${{ needs.docker.outputs.artifact-url || needs.npm.outputs.artifact-url || needs.python.outputs.artifact-url || needs.go-binary.outputs.artifact-url }}
      version: ${{ needs.docker.outputs.version || needs.npm.outputs.version || needs.python.outputs.version || needs.go-binary.outputs.version }}
    steps:
      - name: Summarize build
        run: |
          echo "::group::Build Summary"
          echo "Docker: ${{ needs.docker.result }}"
          echo "npm: ${{ needs.npm.result }}"
          echo "Python: ${{ needs.python.result }}"
          echo "Go: ${{ needs.go-binary.result }}"
          echo "::endgroup::"

